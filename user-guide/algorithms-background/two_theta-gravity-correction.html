
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>two_theta gravity correction &#8212; ScippNeutron</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css?v=a0a71c94" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/documentation_options.js?v=5db94ae7"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user-guide/algorithms-background/two_theta-gravity-correction';</script>
    <script src="../../_static/anaconda-icon.js?v=461bdc62"></script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Absorption correction example" href="../absorption-correction.html" />
    <link rel="prev" title="Background on algorithms" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.0.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.svg" class="logo__image only-light" alt="ScippNeutron - Home"/>
    <img src="../../_static/logo-dark.svg" class="logo__image only-dark pst-js-only" alt="ScippNeutron - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/plopp">
    Plopp
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/scippnexus">
    ScippNexus
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/scippneutron" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/scippneutron/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/scippneutron" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/plopp">
    Plopp
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/scippnexus">
    ScippNexus
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/scippneutron" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/scippneutron/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/scippneutron" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chopper/index.html">Choppers</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../chopper/processing-nexus-choppers.html">Reading and processing NeXus choppers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chopper/chopper-cascade.html">Chopper Cascades</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../coordinate-transformations.html">Coordinate Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../groupby.html">GroupBy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../from-mantid-to-scipp.html">From Mantid to Scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../instrument-view.html">Instrument view</a></li>
<li class="toctree-l1"><a class="reference internal" href="../recipes.html">Recipes: How do I …?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../masking-tool.html">Interactive masking tool</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Background on algorithms</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">two_theta gravity correction</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../absorption-correction.html">Absorption correction example</a></li>
</ul>
</div>
</nav></div>
        <div class="sidebar-primary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Derivation-and-approximation">Derivation and approximation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Validity-of-the-approximation">Validity of the approximation</a></li>
</ul>
  </nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/user-guide/algorithms-background/two_theta-gravity-correction.ipynb">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Background on algorithms</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">two_theta gravity correction</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="two_theta-gravity-correction">
<h1>two_theta gravity correction<a class="headerlink" href="#two_theta-gravity-correction" title="Link to this heading">#</a></h1>
<p>The impact of gravity matters in some instruments where large wavelengths are used. This includes SANS and reflectometry. In those cases, we need to take gravity into account when computing the scattering angle <span class="math notranslate nohighlight">\(2\theta\)</span>. This document derives the expression that ScippNeutron uses in this case. Further, this expression contains an approximation that is explained and analyzed further down.</p>
<section id="Derivation-and-approximation">
<h2>Derivation and approximation<a class="headerlink" href="#Derivation-and-approximation" title="Link to this heading">#</a></h2>
<p>After scattering, the neutron travels along curve</p>
<div class="math notranslate nohighlight">
\[\begin{split}C: \vec{c}(t) = \begin{pmatrix}v_x t \\ -\frac{g}{2}t^2 + v_y t \\ v_z t\end{pmatrix}.\end{split}\]</div>
<p>with initial velocity</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vec{v} = v \begin{pmatrix}\cos(\phi)\sin(2\theta) \\ \sin(\phi)\sin(2\theta) \\ \cos(2\theta)\end{pmatrix}, \quad v = \frac{h}{m_n \lambda}.\end{split}\]</div>
<p>For a detector located at <span class="math notranslate nohighlight">\(z_d = v_z t_d\)</span>, this means that the neutron is detected at</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vec{p} = \begin{pmatrix}x_d \\ y_d \\ z_d\end{pmatrix} = \begin{pmatrix}v_x t_d \\ -\frac{g}{2}t_d^2 + v_y t_d \\ v_z t_d\end{pmatrix}.\end{split}\]</div>
<p>To determine the scattering angles, we can consider the point where the neutron would be detected without gravity:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\vec{p}' = \begin{pmatrix}x_d \\ y'_d \\ z_d\end{pmatrix} = \begin{pmatrix}v_x t_d \\ v_y t_d \\ v_z t_d\end{pmatrix} = v t_d \begin{pmatrix}\cos(\phi)\sin(2\theta) \\ \sin(\phi)\sin(2\theta) \\ \cos(2\theta)\end{pmatrix}\end{split}\]</div>
<p>Thus</p>
<div class="math notranslate nohighlight">
\[\tan(2\theta) = \frac{\sqrt{x_d^2 + y_d^{\prime\,2}}}{z_d}, \quad y_d' = y_d + \frac{g}{2} t_d^2 = y_d + \frac{g m_n^2 \lambda^2}{2 h^2} L_2^{\prime\,2}\]</div>
<p>with</p>
<div class="math notranslate nohighlight">
\[L'_2 = \frac{z_d}{\cos(2\theta)}\]</div>
<p>Solving these equations for <span class="math notranslate nohighlight">\(2 \theta\)</span> is difficult. However, the impact of gravity is small, <strong>so we approximate</strong> <span class="math notranslate nohighlight">\(L_2 \approx L'_2\)</span>. And <span class="math notranslate nohighlight">\(L_2 = |\vec{p}|\)</span> is readily available from pixel positions. Note that Mantid uses the same approximation, see <a class="reference external" href="https://docs.mantidproject.org/nightly/algorithms/Q1D-v2.html#q-unit-conversion">Q1D</a>.</p>
</section>
<section id="Validity-of-the-approximation">
<h2>Validity of the approximation<a class="headerlink" href="#Validity-of-the-approximation" title="Link to this heading">#</a></h2>
<p>We found evidence that the approximation has an unexpectedly large impact on the end result (<span class="math notranslate nohighlight">\(I(Q)\)</span>). Initially, this was observed by using <span class="math notranslate nohighlight">\(\sin(2 \theta) = \sqrt{x^2 + y'^2} / L_2\)</span> instead of the tangent-based equation for <span class="math notranslate nohighlight">\(2 \theta\)</span>. This equation is also an approximation. But it would be exact if it used <span class="math notranslate nohighlight">\(L'_2\)</span> in the denominator instead of <span class="math notranslate nohighlight">\(L_2\)</span>.</p>
<p>With SANS2D data, we found a relative difference of <span class="math notranslate nohighlight">\(~10^{-5}\)</span> in the resulting <span class="math notranslate nohighlight">\(2 \theta\)</span>. This amounted to a relative difference of <span class="math notranslate nohighlight">\(~10^{-4}\)</span> in <span class="math notranslate nohighlight">\(I(Q)\)</span> which is within statistical uncertainties. However, LOKI is rather long and allows for measuring relatively large angles. So it is a priori not clear that the approximation holds.</p>
<p>To test it, we</p>
<ol class="arabic simple">
<li><p>Pick a set of values of <span class="math notranslate nohighlight">\(\lambda\)</span>, <span class="math notranslate nohighlight">\(z_d\)</span>, <span class="math notranslate nohighlight">\(2 \theta\)</span>, <span class="math notranslate nohighlight">\(\phi\)</span>.</p></li>
<li><p>Compute <span class="math notranslate nohighlight">\(\vec{p}\)</span> from those.</p></li>
<li><p>Compute <span class="math notranslate nohighlight">\(2 \theta\)</span> using <span class="math notranslate nohighlight">\(\vec{p}\)</span> and the equation for <span class="math notranslate nohighlight">\(\tan(2\theta)\)</span>.</p></li>
</ol>
<p>The code below outputs a figure that shows the relative difference <code class="docutils literal notranslate"><span class="pre">true_two_theta</span> <span class="pre">-approx_two_theta)</span> <span class="pre">/</span> <span class="pre">true_two_theta</span></code> for <span class="math notranslate nohighlight">\(\phi = 90^{\circ}\)</span>. true_two_theta is the input value for <span class="math notranslate nohighlight">\(2 \theta\)</span> and approx_two_theta is the result of the computation described above. Parameters were chosen in realistic ranges for LOKI. The error of the approximation is no larger than <span class="math notranslate nohighlight">\(~10^{-6}\)</span>. So the impact on the final <span class="math notranslate nohighlight">\(I(Q)\)</span> will likely be within statistical uncertainties and can be
neglected.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipp.constants</span>


<span class="k">def</span><span class="w"> </span><span class="nf">two_theta_approx</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">wavelength</span><span class="p">,</span>
    <span class="n">two_theta</span><span class="p">,</span>
    <span class="n">phi</span><span class="p">,</span>
    <span class="n">z_det</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">m_n</span> <span class="o">/</span> <span class="n">wavelength</span>
    <span class="n">v_x</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">two_theta</span><span class="p">)</span>
    <span class="n">v_y</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">two_theta</span><span class="p">)</span>

    <span class="n">t_det</span> <span class="o">=</span> <span class="n">z_det</span> <span class="o">/</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">two_theta</span><span class="p">))</span>
    <span class="n">x_det</span> <span class="o">=</span> <span class="n">v_x</span> <span class="o">*</span> <span class="n">t_det</span>
    <span class="n">y_det</span> <span class="o">=</span> <span class="n">v_y</span> <span class="o">*</span> <span class="n">t_det</span>
    <span class="n">y_det</span> <span class="o">=</span> <span class="n">y_det</span> <span class="o">-</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">t_det</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">y_det</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

    <span class="n">L2</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_det</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_det</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z_det</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">drop</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">g</span>
        <span class="o">/</span> <span class="mi">2</span>
        <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">m_n</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">*</span> <span class="n">wavelength</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">/</span> <span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">*</span> <span class="n">L2</span><span class="o">**</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">y_det_prime</span> <span class="o">=</span> <span class="n">y_det</span> <span class="o">+</span> <span class="n">drop</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">y_det</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_det</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_det_prime</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">z_det</span><span class="p">)</span>


<span class="n">wavelength</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Å&quot;</span><span class="p">)</span>
<span class="n">two_theta</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="s2">&quot;two_theta&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;rad&quot;</span><span class="p">)</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="mf">90.0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;rad&quot;</span><span class="p">)</span>
<span class="n">z_det</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="s2">&quot;z_det&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>

<span class="n">approx</span> <span class="o">=</span> <span class="n">two_theta_approx</span><span class="p">(</span>
    <span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">two_theta</span><span class="o">=</span><span class="n">two_theta</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">z_det</span><span class="o">=</span><span class="n">z_det</span>
<span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">two_theta</span> <span class="o">-</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="n">two_theta</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">error</span><span class="p">,</span>
    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;two_theta&quot;</span><span class="p">:</span> <span class="n">two_theta</span><span class="p">,</span> <span class="s2">&quot;z_det&quot;</span><span class="p">:</span> <span class="n">z_det</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="n">phi</span><span class="p">,</span> <span class="s2">&quot;wavelength&quot;</span><span class="p">:</span> <span class="n">wavelength</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]),</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">lambda$=</span><span class="si">{</span><span class="n">da</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$</span><span class="se">\\</span><span class="s2">AA$&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_algorithms-background_two_theta-gravity-correction_1_0.png" src="../../_images/user-guide_algorithms-background_two_theta-gravity-correction_1_0.png" />
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Background on algorithms</p>
      </div>
    </a>
    <a class="right-next"
       href="../absorption-correction.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Absorption correction example</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025 Scipp contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
Current ScippNeutron version: 0.0.0 (<a href="https://github.com/scipp/scippneutron/releases">older versions</a>).</div>
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>